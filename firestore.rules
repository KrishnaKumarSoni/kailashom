rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isStringField(field, maxLen) {
      return field is string && field.size() > 0 && field.size() <= maxLen;
    }

    function isNullableString(field, maxLen) {
      return field == null || (field is string && field.size() <= maxLen);
    }

    match /reviews/{reviewId} {
      allow read: if true;

      allow create: if request.resource.data.keys().hasOnly(['name', 'feedback', 'rating', 'mediaUrl', 'mediaType', 'createdAt', 'approved', 'hidden'])
        && isStringField(request.resource.data.name, 80)
        && isStringField(request.resource.data.feedback, 1200)
        && request.resource.data.rating is number
        && request.resource.data.rating >= 1 && request.resource.data.rating <= 5
        && isNullableString(request.resource.data.mediaUrl, 1024)
        && (request.resource.data.mediaType == null || request.resource.data.mediaType in ['image', 'video'])
        && (request.resource.data.createdAt == request.time || request.resource.data.createdAt is timestamp)
        && request.resource.data.approved == false
        && request.resource.data.hidden == false;

      allow update: if request.resource.data.diff(resource.data).affectedKeys().hasOnly(['approved', 'hidden'])
        && (request.resource.data.approved is bool)
        && (request.resource.data.hidden is bool);

      allow delete: if false;
    }
  }
}
